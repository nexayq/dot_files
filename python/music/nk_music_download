#!/usr/bin/env python3

# Get newest youtube-dl version
    #  cd ~/local_bin
    #  wget https://yt-dl.org/downloads/latest/youtube-dl
    #  chmod +x youtube-dl
    #  # check youtube-dl version
    #  youtube-dl --version

# Using youtube-dl to download playlist items:
    # > youtube-dl --playlist-start 1 --playlist-end 50 --extract-audio --audio-format mp3 --output "%(title)s.%(ext)s" https://www.youtube.com/playlist?list=PLqqxFBxt_EUsLoX4F37iByy0ys4BZT8zi

# Usage: ./nk_music_download 5 7
# Usage: ./nk_music_download 3
# Limitations: Only 100 videos can be downloaded

# Reference: https://gist.github.com/fffaraz/f3dcf48ae93b6c04adb9d74b1de711e5

import sys
import os
import time
from bs4 import BeautifulSoup
import requests

def nk_wait_process_exit(window):
    ret = 0
    # grep_string = "[y]outube-dl"
    grep_string = "[" + window[0] + "]" + window[1:]
    # print(grep_string)
    ## https://unix.stackexchange.com/a/74186/156466
    ## https://www.ibm.com/developerworks/library/l-keyc3/#code10

    while ret == 0:
        ret = os.system('ps -ef | grep -i {0} -q'.format(grep_string))
        # https://stackoverflow.com/a/22101965/2450748
        #  print("loading " + window)
        time.sleep(1)

#  nk_wait_process_exit("youtube-dl")
#  nk_wait_window_load("gedit")

# download songs/videos from playlist
def downloadPlaylistLinks(url):
    i = 0
    sourceCode = requests.get(url).text
    soup = BeautifulSoup(sourceCode, 'html.parser')
    domain = 'https://www.youtube.com'
    for link in soup.find_all("a", {"dir": "ltr"}):
        href = link.get('href')
        if href.startswith('/watch?'):
            #  print(link.string.strip())
            #  print(domain + href + '\n')
            i = i + 1
            if i >= int(sys.argv[1]):
                print(link.string.strip())
                print(domain + href + '\n')
                #  youtube-dl --extract-audio --audio-format mp3 --output "%(title)s.%(ext)s" https://www.youtube.com/watch?v=IlVJNrzf_uI&index=97&list=PLqqxFBxt_EUsLoX4F37iByy0ys4BZT8zi
                os.system('youtube-dl --extract-audio --audio-format mp3 --output "%(title)s.%(ext)s" {0}'.format(domain + href))
                nk_wait_process_exit("youtube-dl")
                #  print("NK num_args:" + str(len(sys.argv)))
                if len(sys.argv) < 3 or i >= int(sys.argv[2]):
                    break


# print help
if len(sys.argv) < 2 or sys.argv[1] == "-h" \
                     or sys.argv[1] == "--help":
    print("""
    > nk_music_download start_index [stop_index]

    Example usages:
        Download playlist songs from 5 to 7:
            > nk_music_download 5 7

        Download playlist song 3:
            > nk_music_download 3

    Limitations: Maximum of 100 songs/videos can be downloaded!
                 start_index must be lower or equal to 100!
                 stop_index  must be lower or equal to 100!
    """)
    exit(1)

# download songs/videos from playlist
downloadPlaylistLinks('https://www.youtube.com/playlist?list=PLqqxFBxt_EUsLoX4F37iByy0ys4BZT8zi')
